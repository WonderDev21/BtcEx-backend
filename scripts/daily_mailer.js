const logger = require('winston');
const path = require('path');
const fs = require('fs');
const _ = require('lodash');
const exchangeService = require('../services/poloneix.service');
const emailService = require('../services/email.service');
const userService = require('../services/user.service');
exports.sendDailyMail = async () => {
  try {
    // const currencyPrices = await exchangeService.getCurrencyPrice();
    const [emails, currencyPrices] = await Promise.all([userService.getDailyPriceNotificationUsers(), exchangeService.getCurrencyPrice()]);
    // const currencyPrices = await exchangeService.getCurrencyPrice();
    console.log(currencyPrices);
    // const currencyPrices = {"BTC":{"change":"2.04","price":6247.36},"BCN":{"change":"0.00000000","price":0.0013744192},"BELA":{"change":"-0.00495049","price":0.1004575488},"BLK":{"change":"-0.01784037","price":0.195854736},"BTCD":{"change":"0.01077062","price":102.6486853728},"BTM":{"change":"-0.05903997","price":0.361097408},"BTS":{"change":"0.05708013","price":0.059974656},"BURST":{"change":"-0.03883495","price":0.0061848864},"CLAM":{"change":"-0.06562017","price":3.443544832},"DASH":{"change":"-0.04815805","price":277.382784},"DGB":{"change":"-0.06000000","price":0.0088712512},"DOGE":{"change":"0.00000000","price":0.0011869984},"EMC2":{"change":"0.02262016","price":0.067783856},"FLDC":{"change":"0.05970149","price":0.0088712512},"FLO":{"change":"-0.16686046","price":0.0898995104},"GAME":{"change":"-0.05561788","price":1.8386605216},"GRC":{"change":"0.01740506","price":0.0401705248},"HUC":{"change":"-0.01152737","price":0.086213568},"LTC":{"change":"-0.05416602","price":54.8831200736},"MAID":{"change":"0.01862292","price":0.3724051296},"OMNI":{"change":"0.00101093","price":23.1501547424},"NAUT":{"change":"0.03153988","price":0.1039560704},"NAV":{"change":"-0.05349272","price":0.8866253312},"NEOS":{"change":"-0.05837588","price":2.4418431296},"NMC":{"change":"-0.00285680","price":1.0684859808},"NOTE":{"change":"0.00732600","price":0.0344229536},"NXT":{"change":"-0.05846153","price":0.0576006592},"PINK":{"change":"-0.05246913","price":0.0191793952},"POT":{"change":"0.02088167","price":0.0825276256},"PPC":{"change":"0.01368493","price":1.203553904},"RIC":{"change":"-0.13701657","price":0.049666512},"SJCX":{"change":"-0.10165586","price":0.3897103168},"STR":{"change":"-0.08464566","price":0.029050224},"SYS":{"change":"-0.16704176","price":0.2080995616},"VIA":{"change":"0.01577201","price":1.398783904},"XVC":{"change":"0.16752060","price":0.325799824},"VRC":{"change":"0.01410727","price":0.4311303136},"VTC":{"change":"0.00987502","price":5.2246046944},"XBC":{"change":"-0.00751847","price":38.6709085056},"XCP":{"change":"-0.04141688","price":9.8598334464},"XEM":{"change":"-0.07430150","price":0.188357904},"XMR":{"change":"-0.05927894","price":86.3009685664},"XPM":{"change":"0.00303030","price":0.1260717248},"XRP":{"change":"-0.04793488","price":0.1973541024},"ETH":{"change":"-0.04656718","price":299.9418135392},"SC":{"change":"-0.06557377","price":0.0036234688},"BCY":{"change":"-0.02705023","price":0.2831303552},"EXP":{"change":"0.13686708","price":2.25842064},"FCT":{"change":"-0.06913018","price":14.5158659072},"RADS":{"change":"0.00379606","price":3.1375491392},"AMP":{"change":"-0.03774367","price":0.146188224},"DCR":{"change":"-0.09970788","price":26.55128},"LSK":{"change":"-0.02957634","price":4.7453072352},"LBC":{"change":"-0.09683794","price":0.144314016},"STEEM":{"change":"-0.04458559","price":0.9634678592},"SBD":{"change":"-0.04692026","price":0.9454129888},"ETC":{"change":"-0.05598450","price":10.4167855904},"REP":{"change":"-0.01610691","price":17.2066663328},"ARDR":{"change":"0.00123954","price":0.2014148864},"ZEC":{"change":"-0.08381036","price":228.0284525792},"STRAT":{"change":"-0.22588106","price":3.3661400416},"NXC":{"change":"-0.05140585","price":0.208661824},"PASC":{"change":"-0.00102249","price":0.3052460096},"GNT":{"change":"-0.05294863","price":0.1866086432},"GNO":{"change":"-0.06996589","price":70.2776771648},"BCH":{"change":"-0.05768783","price":436.4753673952},"ZRX":{"change":"-0.09214795","price":0.1747386592},"CVC":{"change":"-0.09306662","price":0.3362953888},"OMG":{"change":"-0.06846959","price":6.9504378944},"GAS":{"change":"-0.05875831","price":17.6613491936},"STORJ":{"change":"-0.12441745","price":0.38733632}};
    const emailTemplate = fs.readFileSync(path.join(process.cwd(), 'mailer/output/dailyMail.html'));
    let htmlStr = '';
    _.forEach(currencyPrices, (val, key) => {
      const subT = '<tr><td>${key}</td><td>${change}</td><td>${price}</td></tr>';
      const compiled = _.template(subT);
      const output = compiled({
          price: Number(val.price).toFixed(2),
          change: Number(val.change).toFixed(2),
          key: key
        });
      htmlStr += output;
    });
    const compiled = _.template(emailTemplate);
    const emailHtml = compiled({PRICE_TABLE: htmlStr});
    // console.log(emails);
    const emailObj = {
      name: 'Coinmint Notification',
      subject: 'Daily Price Notification',
      html: emailHtml,
      list: ['vk92kokil@gmail.com', 'suresh@mailinator.com'],
    };
    // const resp = await emailService.sendMultipleEmail(emailObj);
    // logger.info('Emails sent', resp);
  } catch(error) {
    logger.error('Error while fetching data', error);
    // res.status(400).send({ message: 'Error in order cancel', error: error });
  }
};
// exports.sendDailyMail();
////{"BTC":{"change":"2.04","price":6247.36},"BCN":{"change":"0.00000000","price":0.0013744192},"BELA":{"change":"-0.00495049","price":0.1004575488},"BLK":{"change":"-0.01784037","price":0.195854736},"BTCD":{"change":"0.01077062","price":102.6486853728},"BTM":{"change":"-0.05903997","price":0.361097408},"BTS":{"change":"0.05708013","price":0.059974656},"BURST":{"change":"-0.03883495","price":0.0061848864},"CLAM":{"change":"-0.06562017","price":3.443544832},"DASH":{"change":"-0.04815805","price":277.382784},"DGB":{"change":"-0.06000000","price":0.0088712512},"DOGE":{"change":"0.00000000","price":0.0011869984},"EMC2":{"change":"0.02262016","price":0.067783856},"FLDC":{"change":"0.05970149","price":0.0088712512},"FLO":{"change":"-0.16686046","price":0.0898995104},"GAME":{"change":"-0.05561788","price":1.8386605216},"GRC":{"change":"0.01740506","price":0.0401705248},"HUC":{"change":"-0.01152737","price":0.086213568},"LTC":{"change":"-0.05416602","price":54.8831200736},"MAID":{"change":"0.01862292","price":0.3724051296},"OMNI":{"change":"0.00101093","price":23.1501547424},"NAUT":{"change":"0.03153988","price":0.1039560704},"NAV":{"change":"-0.05349272","price":0.8866253312},"NEOS":{"change":"-0.05837588","price":2.4418431296},"NMC":{"change":"-0.00285680","price":1.0684859808},"NOTE":{"change":"0.00732600","price":0.0344229536},"NXT":{"change":"-0.05846153","price":0.0576006592},"PINK":{"change":"-0.05246913","price":0.0191793952},"POT":{"change":"0.02088167","price":0.0825276256},"PPC":{"change":"0.01368493","price":1.203553904},"RIC":{"change":"-0.13701657","price":0.049666512},"SJCX":{"change":"-0.10165586","price":0.3897103168},"STR":{"change":"-0.08464566","price":0.029050224},"SYS":{"change":"-0.16704176","price":0.2080995616},"VIA":{"change":"0.01577201","price":1.398783904},"XVC":{"change":"0.16752060","price":0.325799824},"VRC":{"change":"0.01410727","price":0.4311303136},"VTC":{"change":"0.00987502","price":5.2246046944},"XBC":{"change":"-0.00751847","price":38.6709085056},"XCP":{"change":"-0.04141688","price":9.8598334464},"XEM":{"change":"-0.07430150","price":0.188357904},"XMR":{"change":"-0.05927894","price":86.3009685664},"XPM":{"change":"0.00303030","price":0.1260717248},"XRP":{"change":"-0.04793488","price":0.1973541024},"ETH":{"change":"-0.04656718","price":299.9418135392},"SC":{"change":"-0.06557377","price":0.0036234688},"BCY":{"change":"-0.02705023","price":0.2831303552},"EXP":{"change":"0.13686708","price":2.25842064},"FCT":{"change":"-0.06913018","price":14.5158659072},"RADS":{"change":"0.00379606","price":3.1375491392},"AMP":{"change":"-0.03774367","price":0.146188224},"DCR":{"change":"-0.09970788","price":26.55128},"LSK":{"change":"-0.02957634","price":4.7453072352},"LBC":{"change":"-0.09683794","price":0.144314016},"STEEM":{"change":"-0.04458559","price":0.9634678592},"SBD":{"change":"-0.04692026","price":0.9454129888},"ETC":{"change":"-0.05598450","price":10.4167855904},"REP":{"change":"-0.01610691","price":17.2066663328},"ARDR":{"change":"0.00123954","price":0.2014148864},"ZEC":{"change":"-0.08381036","price":228.0284525792},"STRAT":{"change":"-0.22588106","price":3.3661400416},"NXC":{"change":"-0.05140585","price":0.208661824},"PASC":{"change":"-0.00102249","price":0.3052460096},"GNT":{"change":"-0.05294863","price":0.1866086432},"GNO":{"change":"-0.06996589","price":70.2776771648},"BCH":{"change":"-0.05768783","price":436.4753673952},"ZRX":{"change":"-0.09214795","price":0.1747386592},"CVC":{"change":"-0.09306662","price":0.3362953888},"OMG":{"change":"-0.06846959","price":6.9504378944},"GAS":{"change":"-0.05875831","price":17.6613491936},"STORJ":{"change":"-0.12441745","price":0.38733632}}
